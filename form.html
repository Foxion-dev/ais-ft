
<?php
header('X-Frame-Options: GOFORIT'); 
header('X-Frame-Options: ALLOW');
 
$utm_source   = 'метка1';
$utm_medium   = 'метка2';
$utm_campaign = 'метка3';

//$MK = ''; // Метка MK, если нужна

$linkSuccess = 'http://'.$_SERVER['HTTP_HOST'].'/thankyoupage.php';

// Bitrix24 add to lead
if(!empty($_POST)){
    $b24Url = "https://kuznitsakadrov.bitrix24.ru";	
	$b24UserID = "568";						
	$b24WebHook = "vmbckvmwpvyxx8e4";		
	
	// формируем URL, на который будем отправлять запрос
	$queryURL = "$b24Url/rest/$b24UserID/$b24WebHook/crm.lead.add.json";	
	
	// формируем параметры для создания лида	
	$queryData = http_build_query(array(
		"fields" => array(
			"TITLE" => "Лид с сайта " . $_SERVER['HTTP_HOST'],	    // название лида
			"NAME" => $_POST['name'] ?: 'Без имени',				// имя
			"PHONE" => array(	
				"0" => array(
					"VALUE" =>  htmlspecialchars($_POST['phone']),	// номер
					"VALUE_TYPE" => "MOBILE",			            // тип номера = мобильный
				),
			),
			"EMAIL" => array(
				"0" => array(
					"VALUE" =>  htmlspecialchars($_POST['email']),	// почта
				),
			),
			"UTM_SOURCE"    =>$utm_source, // UTM метки
			"UTM_MEDIUM"    =>$utm_medium,
			"UTM_CAMPAIGN"  =>$utm_campaign,
			"UF_CRM_MK"     =>$MK ?: $_POST['MK'],
			"UF_CRM_MKDATE" =>$_POST['MKDATE'],
		),
		'params' => array("REGISTER_SONET_EVENT" => "Y")	// Y = произвести регистрацию события добавления лида в живой ленте.
	));

	// отправляем запрос в Б24 и обрабатываем ответ
	
	$curl = curl_init();
	curl_setopt_array($curl, array(
		CURLOPT_SSL_VERIFYPEER => 0,
		CURLOPT_POST => 1,
		CURLOPT_HEADER => 0,
		CURLOPT_RETURNTRANSFER => 1,
		CURLOPT_URL => $queryURL,
		CURLOPT_POSTFIELDS => $queryData,
	));
	$result = curl_exec($curl);
	curl_close($curl);
	$result = json_decode($result,1); 
 
	// если произошла какая-то ошибка - выведем её
	if(array_key_exists('error', $result))
	{      
		die("Ошибка при сохранении лида: ".$result['error_description']);
	}
	
}

// Mailchimp add to contact

function mailChimpAddToContact($data) {
    $apiKey = '6164f4392aa30451aa74a53acb58d5e5-us20';
    $listId = '3529a796e7';
    
    $memberId = md5(strtolower($data['email']));
    $dataCenter = substr($apiKey,strpos($apiKey,'-')+1);
    $url = 'https://us20.api.mailchimp.com/3.0/lists/' . $listId . '/members/' . $memberId;
    
    $json = json_encode([
    'email_address' => htmlspecialchars($data['email']),
    'status'        => 'subscribed', // "subscribed","unsubscribed","cleaned","pending"
    'merge_fields'  => [
        'FNAME'         => $data['name'] ?: '',
        "PHONE"         => $data['phone']?: '',
        'MK'            => $data['MK'] ?: '',
        'MKDATE'        => $data['MKDATE'] ?: '',
        'SOURCE'        => $data['SOURCE'] ?: '' ,
        ]
    ]);
     
    $ch = curl_init($url);
    
    curl_setopt($ch, CURLOPT_USERPWD, 'user:' . $apiKey);
    curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 10);
    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'PUT');
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    curl_setopt($ch, CURLOPT_POSTFIELDS, $json);
    
    $result = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    return $httpCode;
    
}

if(!empty($_POST)){
    
     $data = [
        'email'         => htmlspecialchars($_POST['email']),
        'status'        => 'subscribed', // "subscribed","unsubscribed","cleaned","pending"
        'name'          => $_POST['name'],
        'phone'         => htmlspecialchars($_POST['phone']),
        'MK'            => $MK ?: $_POST['MK'],
        'MKDATE'        => $_POST['MKDATE'],
        'SOURCE'        => $_SERVER['HTTP_HOST'],
        "UTM_SOURCE"    => $utm_source,
		"UTM_MEDIUM"    => $utm_medium,
		"UTM_CAMPAIGN"  => $utm_campaign,
    ];

    
    mailChimpAddToContact($data);  
}

header('Location:'. $linkSuccess );

?>

<form class="form-default" method="POST" action="/">

	<div class="form-default__input-wrap">
		<input type="text"  placeholder="E-mail" required name="email" value="">
	</div>
	<div class="form-default__input-wrap">
		<input type="text"  placeholder="Имя и фамилия" name="name" value="">
	</div>
	<div class="form-default__input-wrap">
		<input type="text"  placeholder="Телефон" pattern="+[0-9]*" required name="phone" value="">
	</div>
	<input type="hidden" name="MK" value="FB">
	<input type="hidden" name="MKDATE" value="autodate">

	<div class="form-default__submit-wrap">
		<button class="form-default__submit-btn" type="submit" value="Отправить"> Отправить</button>
	</div>

</form>

<style>

.form-default{
	display: flex;
	flex-direction: column;
	max-width: 800px;
	margin: 0 auto;
	align-items: center;
	padding: 50px;
	box-sizing: border-box;
	
}
.form-default__input-wrap{
	width: 100%;
	margin-bottom: 30px;
	box-sizing: border-box;
}
.form-default__input-wrap input{
	width: 100%;
	height: 50px;
	padding: 10px 15px;
	border: 2px solid #e5e5e5;
	border-radius: 5px;
	box-shadow: 0 0 20px #d5d5d5;
	font-size: 14px;
	box-sizing: border-box;
}
.form-default__input-wrap input:hover, .form-default__input-wrap input:focus, .form-default__input-wrap input:active{
	outline: none;
}
.form-default__submit-wrap{
	width: 100%;

}
.form-default__submit-btn{
	display: flex;
	align-items: center;
	justify-content: center;
	padding: 10px 15px;
	margin: 0 auto;
	font-size: 16px;
	max-width: 300px;
	width: 100%;
	height: 50px;
	border-radius: 5px;
	box-shadow: 0 0 20px #d5d5d5;
	outline: none;
	border: none;
	background: tomato;
	color: white;
	transition: all 0.3s linear;	
	cursor: pointer;
	position: relative;
	overflow: hidden;
	z-index: 1;
	box-sizing: border-box;
}
.form-default__submit-btn:before{
	content: '';
	position: absolute;
	top: 0;
	right: calc(100% + 20px);
	width: 100%;
	height: 100%;
	background: #000;
	transition: all 0.3s linear;	
	z-index: -1;
	box-sizing: border-box;
	
}
.form-default__submit-btn:hover{
	transform: translateY(-5px);
	color: white;

}
.form-default__submit-btn:hover:before{
	right: 0;
}
</style>


<script>
	// День недели для смены даты 0 - воскресенье, 1 - понедельник...
	var weekDay = [];
	weekDay[0] = 0;
	weekDay[1] = 1;
	weekDay[2] = 2;
	weekDay[3] = 3;
	weekDay[4] = 4;
	weekDay[5] = 5;
	weekDay[6] = 6;
	
	// Час, после которого менять дату в указанный день
	var changeTime = 5;
	
	// Month names on Russin
	var monthNames = ["января", "февраля", "марта", "апреля", "мая", "июня","июля", "августа", "сентября", "октября", "ноября", "декабря"];
	
	// Days names on Russin
	var daysNames = ["воскресенье", "понедельник", "вторник", "среда", "четверг", "пятница","суббота"];
	
	// Function to add hours to current time
	Date.prototype.addHours = function(h) {
			this.setTime(this.getTime() + (h*60*60*1000));
			return this;
	}
	
	// Current time
	//var now = new Date(2019,04,10,17,00,00);
	var now = new Date();
	
	// +3 hours, fix for utc to Moscow time
	now.addHours( 3 );
	
	// Get Moscow utc time
	var nowUTC = new Date( now.getFullYear(), now.getUTCMonth(), now.getUTCDate(), now.getUTCHours(), now.getUTCMinutes(), now.getUTCSeconds(), now.getUTCMilliseconds() );
	//var nowUTC = new Date( 2019, 04, 16, 17, 00, 00, 00 );
	
	// Current day
	var cDay = nowUTC.getDay();
	console.log('Day: '+cDay);
	
	// Get current hours
	var hours = nowUTC.getHours();
	
	// Set correct days
	var changeDay = weekDay[0];
	
	for(var i = 0; i <= 6; i++){
			if(cDay == weekDay[i] && hours >= changeTime){
					if(i < 6) {
							changeDay = weekDay[i + 1];
					} else {
							changeDay = weekDay[0];
					}
			} else if(cDay == weekDay[i] && hours < changeTime){
					changeDay = weekDay[i];
			}
	}
	console.log('Change Day: '+changeDay);
	
	if(hours < changeTime){
			var addDays = 0;
	} else {
			var addDays = 1;
	}
	
	nowUTC.setTime(nowUTC.getTime() + (addDays * 24 * 60 * 60 * 1000));
	
	// Get day and month in format: 1 января
	var day = nowUTC.getDate();
	var dayNum = nowUTC.getDay();
	var dayRusName = daysNames[dayNum];
	var month = monthNames[nowUTC.getMonth()];
	
	var monthNum = String( nowUTC.getMonth() + 1 );
	var dateNum = String( nowUTC.getDate() );
	
	if ( monthNum.length < 2 ) {
			monthNum = '0' + monthNum;
	}
	if ( dateNum.length < 2 ) {
			dateNum = '0' + dateNum;
	}
	//Меняем mkDate каждый день
	var mkDate = dateNum + '.' + monthNum + '.' + nowUTC.getFullYear();
	
	console.log('Day name: '+dayRusName);
	console.log(mkDate);
	
	// write date in document html
	$(document).ready(function(){
			$('input[name="MKDATE"]').val( mkDate );
	
			$('body').find('a[href="#autodate"]').each(function(){
					$(this).after( day + ' ' + month + ' (' + dayRusName + ')' );
					$(this).remove();
			});
	
			$('body').find('a[href="#mkDate"]').each(function(){
					$(this).after( mkDate );
					$(this).remove();
			});
	});
	</script>
	